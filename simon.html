<!doctype html>

<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="description" content="Simon game. Test your memory!">
<meta name="author" content="Kevin Nolan">

<link href="https://fonts.googleapis.com/css?family=Catamaran" rel="stylesheet">

<title>Simon</title>

<style>
.sb { /* Class for all Simon buttons*/
  height: 100px;
  width: 200px;
  cursor: pointer;
}
.sb:disabled {
  cursor: not-allowed;
}

.red-btn {
  background-color: #900;
}
.red-btn:active {
  background-color: #f55;
}
.red-btn-lit {
  background-color: #f55;
}

.blue-btn {
  background-color: #009;
}
.blue-btn:active {
  background-color: #55f;
}
.blue-btn-lit {
  background-color: #55f;
}

.yellow-btn {
  background-color: #990
}
.yellow-btn:active {
  background-color: #ff9;
}
.yellow-btn-lit {
  background-color: #ff9;
}

.green-btn {
  background-color: #090;
}
.green-btn:active {
  background-color: #9f9;
}
.green-btn-lit {
  background-color: #9f9;
}

</style>
</head>

<body>
<audio id = "note0">
  <source src="sounds/39200__jobro__piano-ff-052.wav" type="audio/wav">
</audio>
<audio id = "note1">
  <source src="sounds/39202__jobro__piano-ff-054.wav" type="audio/wav">
</audio>
<audio id = "note2">
  <source src="sounds/39204__jobro__piano-ff-056.wav" type="audio/wav">
</audio>
<audio id = "note3">
  <source src="sounds/39206__jobro__piano-ff-058.wav" type="audio/wav">
</audio>

<h1>Simon</h1>
<p id="disp-level">&nbsp;</p>
<p><button id="start-btn" onclick="restart()">Start</button>
  <button id="strict-btn" onclick="setStrict()">Strict: Off</button>
  <button id="max-level" onclick="setLevel()">Hard (20 levels)</button> </p>
<button id="red-btn" disabled class="sb red-btn" onclick="pressSB(0)"></button><br>
<button id="blue-btn" disabled class="sb blue-btn" onclick="pressSB(1)"></button><br>
<button id="yellow-btn" disabled class="sb yellow-btn" onclick="pressSB(2)"></button><br>
<button id="green-btn" disabled class="sb green-btn" onclick="pressSB(3)"></button>

<script>
//Note source: https://www.freesound.org/people/jobro/packs/2489/?page=2#sound

// Presented with a random sequence of button presses
// DONE: Each time I enter the sequence correctly I see the same series with an extra step
// DONE: Each step has audio and lights up
// DONE: If I press the wrong button I'm told I have done so and the sequence repeats so I can retry.
// DONE: I can see how many steps I've gone so far
// DONE: I can restart to go back to a single step
// DONE: A strict mode option where getting a step wrong returns me to the restart
// If I get 20 steps right I win the game, am notified of my victory and the game restarts
// Bonus: user-settable win steps including endless
const sequence = []; // r=0, b=1, y=2, g=3
let rightSoFar = 0; // How many steps the player gets right this turn
// Timeout and Set Interval vars: have root scope so I can cancel them on reset
const t = {}; // Timers - for easily clearing setInterval and setTimeout objects 
let strict = false;
let maxLev = 20;

const btn = [
  {elem: document.getElementById("red-btn"), sound: document.getElementById("note0"), dClass: "sb red-btn", lClass: "sb red-btn-lit"},
  {elem: document.getElementById("blue-btn"), sound: document.getElementById("note1"), dClass: "sb blue-btn", lClass: "sb blue-btn-lit"},
  {elem: document.getElementById("yellow-btn"), sound: document.getElementById("note2"), dClass: "sb yellow-btn", lClass: "sb yellow-btn-lit"},
  {elem: document.getElementById("green-btn"), sound: document.getElementById("note3"), dClass: "sb green-btn", lClass: "sb green-btn-lit"}];

  let stBtn = document.getElementById("start-btn");


function setStrict() {
  const strictB = document.getElementById("strict-btn");
  if (strict) {
    strict = false;
    strictB.innerHTML="Strict: Off";
  } else {
    strict = true;
    strictB.innerHTML = "Strict: On";
  }
}

function restart() { // Handles both starting and restarting
  for (let prop in t) clearTimeout(t[prop]); // Clear all timeouts and setIntervals
  stBtn.innerHTML = "Restart";
  playerTurn(false);
  sequence.length = 0;
  rightSoFar = 0;
  btn.forEach((i) => i.elem.className = i.dClass); //Return all buttons to dark
  addStep();
}

function gameOver() {
  console.log('Press Start to begin a new game');
  stBtn.innerHTML = "Start";

}

function pressSB(btnPressed) {
  if (btnPressed == sequence[rightSoFar]) {
    rightSoFar += 1;
    btn[btnPressed].sound.currentTime = 0;
    btn[btnPressed].sound.play();
  } else {
    wrongMove();
  }
  if (rightSoFar >= sequence.length) {
    if (sequence.length >= 5) {
      console.log("Congrats, you beat the game!");
      t.gameWonTO = setTimeout(()=>gameOver(), 500);
    } else {
      console.log("All correct! Next level.");
      addStep();
    }
  }
}

function wrongMove() {
  playerTurn(false);
  if(strict) {
  console.log ("Nope! You lose.");
    t.wrongMoveTO = setTimeout(()=>gameOver(), 500);
  } else {
    console.log ("Nope! Please try again.")
    rightSoFar = 0;
    t.wrongMoveTO = setTimeout(()=>replay(), 500);
  }
}

function setLevel() {
  if (maxLev == 5) maxLev = 10;
  else if (maxLev == 10) maxLev = 20;
  else maxLev = 5;
  updDisplay('level');
}

function updDisplay(inp, arg) {
  // Disable max level button from level 2 until game over
  if (inp == 'level' || inp == 'all') {
    const showLev = document.getElementById("disp-level");
    const levBtn = document.getElementById("max-level");
    showLev.innerHTML = "Level: " + sequence.length + (maxLev == -1 ? "" : " / " + maxLev);
    if (maxLev == 5) levBtn.innerHTML = "Easy (" + maxLev + " levels)";
    else if (maxLev == 10) levBtn.innerHTML = "Medium (" + maxLev + " levels)";
    else levBtn.innerHTML = "Hard (" + maxLev + " levels)";
  }

}

function addStep() {
  playerTurn(false);
  sequence.push(Math.floor(Math.random()*4));
  rightSoFar = 0;
  t.addStepTO = setTimeout(function() {
    updDisplay('level');
    replay();
  }, 500);
}

function replay() {
  let step = 0;
  t.replaySI = setInterval(playStep,500);

  function playStep() {
    btn[sequence[step]].sound.currentTime = 0;
    btn[sequence[step]].sound.play();

    let thisBtn = btn[sequence[step]]; // Choose colour according to position in sequence
    thisBtn.elem.className=thisBtn.lClass; // Change to lit class
    t.toDarkTO = setTimeout(function() {
      thisBtn.elem.className=thisBtn.dClass // Change back to dark class
    },400);
    step +=1;
    if (step >= sequence.length) {
      clearInterval(t.replaySI);
      t.playerTurnTO = setTimeout(() => playerTurn(true),500);
    }
  }
}

function playerTurn(isIt) {
  if (isIt) {
    btn.forEach(val => val.elem.disabled = false);
  } else {
    btn.forEach(val => val.elem.disabled = true);
  }
}

</script>

</body>